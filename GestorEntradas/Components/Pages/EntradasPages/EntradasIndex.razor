@page "/entradas"
@attribute [Authorize]
@inject EntradasService entradasService
@rendermode InteractiveServer

<PageTitle>Index - Entradas</PageTitle>
<div class="container">
	<div class="card shadow-lg">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h5 class="card-title">Entradas</h5>
			<a href="/entradas/create" class="btn btn-outline-primary">
				<span class="bi bi-plus-square mt-3"></span> Agregar Entrada
			</a>
		</div>

		<div class="card-body">
			<div class="row g-3">
				<div class="col-12 col-sm-6 col-md-2">
					<label class="col-form-label">Filtrar Por:</label>
					<InputSelect class="form-select" @bind-Value="Filtro">
						<option value="" selected disabled>Seleccione una opci&oacute;n</option>
						<option value="EntradaId">EntradaId</option>
						<option value="Concepto">Concepto</option>
					</InputSelect>
				</div>

				<div class="col-12 col-sm-6 col-md-2">
					<label class="col-form-label">Desde:</label>
					<InputDate class="form-control" @bind-Value="FechaDesde"></InputDate>
				</div>

				<div class="col-12 col-sm-6 col-md-2">
					<label class="col-form-label">Hasta:</label>
					<InputDate class="form-control" @bind-Value="FechaHasta"></InputDate>
				</div>

				<div class="col-12 col-sm-12 col-md-3">
					<label class="col-form-label">B&uacute;squeda</label>
					<div class="input-group">
						<InputText class="form-control" @bind-Value="ValorFiltro" placeholder="Buscar..."></InputText>
						<button type="button" class="btn btn-outline-primary" @onclick="Buscar">
							<span class="bi bi-search"></span>
						</button>
					</div>
				</div>
			</div>

			<div class="table-responsive mt-3">
				<table class="table table-hover text-center align-middle">
					<thead class="table table-striped text-black">
						<tr>
							<th>Fecha</th>
							<th>ID</th>
							<th>Concepto</th>
							<th>Total</th>
							<th>Acciones</th>
						</tr>
					</thead>

					<tbody>
						@foreach(var e in ListaEntradas)
						{
							<tr>
								<td>@e.FechaEntrada.ToShortDateString()</td>
								<td>@e.EntradaId</td>
								<td>@e.Concepto</td>
								<td>@e.Detalles.Sum(d => d.Cantidad * d.Costo)</td>
								<td>
									<a href="/entradas/edit/@e.EntradaId" class="btn btn-outline-warning">
										<span class="bi bi-pencil"></span>	
									</a>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		</div>

		<div class="card-footer text-center">
			<div class="row">
				<div class="col-6">
					<label>Cantidad de Entradas: @ListaEntradas.Count()</label>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	public List<Entrada> ListaEntradas { get; set; } = new List<Entrada>();
	public string? Filtro { get; set; }
	public string? ValorFiltro { get; set; }
	public DateTime? FechaDesde { get; set; }
	public DateTime? FechaHasta { get; set; }

	protected override async Task OnInitializedAsync()
	{
		ListaEntradas = await entradasService.Listar(e => e.EntradaId > 0);
	}

	public async Task Buscar()
	{
		if (FechaDesde.HasValue && FechaHasta.HasValue)
		{
			ListaEntradas = await entradasService.Listar(
				e => e.FechaEntrada.Date >= FechaDesde.Value && e.FechaEntrada.Date <= FechaHasta.Value
			);
		}
		else if (FechaDesde.HasValue)
		{
			ListaEntradas = await entradasService.Listar(
				e => e.FechaEntrada.Date >= FechaDesde.Value
			);
		}
		else if (FechaHasta.HasValue)
		{
			ListaEntradas = await entradasService.Listar(
				e => e.FechaEntrada.Date <= FechaHasta.Value
			);
		}

		if (!string.IsNullOrWhiteSpace(ValorFiltro))
		{
			if (Filtro == "EntradaId" && int.TryParse(ValorFiltro, out var entradaId))
			{
				ListaEntradas = await entradasService.Listar(e => e.EntradaId == entradaId);
			}
			else if (Filtro == "Concepto")
			{
				ListaEntradas = await entradasService.Listar(e => e.Concepto.ToLower().Contains(ValorFiltro));
			}
		}
	}
}
